{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - DocTrac{% endblock %}

{% block extra_css %}
<style>
    .document-list {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .document-item {
        border-left: 4px solid #dee2e6;
        transition: all 0.2s;
        background-color: #ffffff;
    }
    
    .document-item:hover {
        border-left-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .document-item.active {
        border-left-color: #007bff;
        background-color: #e3f2fd;
    }
    
    .document-item h6 {
        color: #212529 !important;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .document-item .text-muted {
        color: #495057 !important;
        font-weight: 500;
    }
    
    .document-item .text-info {
        color: #0c5460 !important;
        font-weight: 500;
    }
    
    .pdf-viewer {
        min-height: 70vh;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    .categorization-panel {
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .structured-name {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.375rem;
        font-family: monospace;
        font-size: 0.8rem;
        min-height: 2rem;
    }
    
    .categorization-panel .form-label {
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .categorization-panel .form-control,
    .categorization-panel .form-select {
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Columna Izquierda: Lista de Documentos Pendientes (25%) -->
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Documentos Pendientes
                    <span class="badge bg-dark ms-2">{{ pending_count }}</span>
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="document-list">
                    {% if pending_documents %}
                        {% for document in pending_documents %}
                        <div class="document-item p-3 border-bottom" 
                             data-document-id="{{ document.id }}" 
                             style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ document.title|truncatechars:30 }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ document.created_at|date:"d/m/Y" }}
                                    </small>
                                    {% if document.entity %}
                                    <br>
                                    <small class="text-info">
                                        <i class="fas fa-building me-1"></i>
                                        {{ document.entity.name|truncatechars:20 }}
                                    </small>
                                    {% endif %}
                                </div>
                                <span class="badge bg-warning text-dark">
                                    {{ document.get_status_display }}
                                </span>
                            </div>
                            {% if document.file_size %}
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-file-pdf me-1"></i>
                                {{ document.file_size }} MB
                            </small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <p>No hay documentos pendientes</p>
                            <a href="{% url 'documents:document_create' %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus me-1"></i>Subir Documento
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Columna Central: Vista Previa del Documento (50%) -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-eye me-2"></i>Vista Previa
                    <span id="document-title" class="ms-2"></span>
                </h6>
                <div id="pdf-controls" style="display: none;">
                    <a id="open-pdf-tab" href="#" target="_blank" class="btn btn-sm btn-outline-light me-2">
                        <i class="fas fa-external-link-alt me-1"></i>Nueva Pesta√±a
                    </a>
                    <button id="reload-pdf" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-redo me-1"></i>Recargar
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="pdf-viewer-container" class="pdf-viewer">
                    <div id="pdf-placeholder" class="d-flex align-items-center justify-content-center h-100 text-center text-muted">
                        <div>
                            <i class="fas fa-file-pdf fa-4x mb-3"></i>
                            <h5>Selecciona un documento</h5>
                            <p>Haz clic en un documento de la lista para ver su contenido</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Columna Derecha: Panel de Categorizaci√≥n (25%) -->
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-tags me-2"></i>Categorizaci√≥n
                </h6>
                <!--<small class="d-block opacity-75 mt-1">üè¢ Entidad ‚Üí üè∑Ô∏è Categor√≠a ‚Üí üìÑ Tipo ‚Üí üìÖ Fecha</small> -->
            </div>
            <div class="card-body p-2 categorization-panel">
                <div id="categorization-form" style="display: none;">
                    <form id="document-form">
                        {% csrf_token %}
                        <input type="hidden" id="current-document-id" name="document_id">
                        
                        <!-- 1. Entidad (PRIMERO) -->
                        <div class="mb-2">
                            <label for="entity" class="form-label mb-1">
                                <i class="fas fa-building me-1"></i>üè¢ Entidad
                            </label>
                            <select class="form-select form-select-sm" id="entity" name="entity_id">
                                <option value="">Seleccionar entidad...</option>
                                {% for entity in entities %}
                                <option value="{{ entity.id }}">
                                    {{ entity.name }} {% if entity.is_company %}(Empresa){% else %}(Entidad){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 2. Categor√≠a -->
                        <div class="mb-2">
                            <label for="category" class="form-label mb-1">
                                <i class="fas fa-folder me-1"></i>üè∑Ô∏è Categor√≠a
                            </label>
                            <select class="form-select form-select-sm" id="category" name="category_id">
                                <option value="">Seleccionar categor√≠a...</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 3. Tipo de Documento -->
                        <div class="mb-2">
                            <label for="document-type" class="form-label mb-1">
                                <i class="fas fa-file me-1"></i>üìÑ Tipo de Documento
                            </label>
                            <select class="form-select form-select-sm" id="document-type" name="document_type_id" disabled>
                                <option value="">Seleccionar tipo...</option>
                            </select>
                        </div>
                        
                        <!-- Fecha del Documento -->
                        <div class="mb-2">
                            <label for="document-date" class="form-label mb-1">
                                <i class="fas fa-calendar me-1"></i>üìÖ Fecha del Documento
                            </label>
                            <input type="date" class="form-control form-control-sm" id="document-date" name="document_date">
                        </div>
                        
                        <!-- Estado de Pago -->
                        <div class="mb-2">
                            <label for="payment-status" class="form-label mb-1">
                                <i class="fas fa-money-bill me-1"></i>üí∞ Estado de Pago
                            </label>
                            <select class="form-select form-select-sm" id="payment-status" name="payment_status">
                                <option value="not_applicable">No Aplica</option>
                                <option value="paid">Pagado</option>
                                <option value="pending">Pendiente</option>
                                <option value="overdue">Vencido</option>
                            </select>
                        </div>
                        
                        <!-- Estado del Documento -->
                        <div class="mb-2">
                            <label for="status" class="form-label mb-1">
                                <i class="fas fa-tasks me-1"></i>üìã Estado
                            </label>
                            <select class="form-select form-select-sm" id="status" name="status">
                                <option value="pending">Pendiente</option>
                                <option value="scanned">Escaneado</option>
                                <option value="digitized">Digitalizado</option>
                                <option value="categorized">Categorizado</option>
                                <option value="approved">Aprobado</option>
                                <option value="archived">Archivado</option>
                            </select>
                        </div>
                        
                        <!-- Notas -->
                        <div class="mb-2">
                            <label for="notes" class="form-label mb-1">
                                <i class="fas fa-sticky-note me-1"></i>üìù Notas
                            </label>
                            <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2" 
                                      placeholder="Observaciones adicionales..."></textarea>
                        </div>
                        
                        <!-- Nombre Estructurado -->
                        <div class="mb-2">
                            <label class="form-label mb-1">
                                <i class="fas fa-signature me-1"></i>üè∑Ô∏è Nombre Estructurado
                            </label>
                            <div id="structured-name" class="structured-name text-muted">
                                Se generar√° autom√°ticamente...
                            </div>
                        </div>
                        
                        <!-- Botones de Acci√≥n -->
                        <div class="d-grid gap-1 mt-3">
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="fas fa-save me-1"></i>Guardar Cambios
                            </button>
                            <a href="#" id="view-history-btn" class="btn btn-outline-info btn-sm" style="display: none;">
                                <i class="fas fa-history me-1"></i>Ver Historial
                            </a>
                        </div>
                    </form>
                </div>
                
                <div id="no-document-selected" class="text-center text-muted">
                    <i class="fas fa-tags fa-3x mb-3"></i>
                    <h6>Panel de Categorizaci√≥n</h6>
                    <p>Selecciona un documento para comenzar la categorizaci√≥n</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Historial -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>Historial del Documento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="history-content">
                <!-- Contenido del historial se cargar√° aqu√≠ -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentDocumentId = null;
    
    // Manejar clic en documento
    $('.document-item').on('click', function() {
        const documentId = $(this).data('document-id');
        
        // Actualizar UI
        $('.document-item').removeClass('active');
        $(this).addClass('active');
        
        // Cargar documento
        loadDocument(documentId);
    });
    
    // Ocultar controles al inicio
    $('#pdf-controls').hide();
    
    // Cargar documento en viewer y formulario
    function loadDocument(documentId) {
        currentDocumentId = documentId;
        
        // Mostrar el formulario de categorizaci√≥n
        $('#no-document-selected').hide();
        $('#categorization-form').show();
        
        console.log('üîÑ Cargando documento:', documentId);
        
        // Ocultar placeholder y mostrar controles
        $('#pdf-placeholder').hide();
        $('#pdf-controls').show();
        
        // URL del PDF
        const pdfUrl = `/documents/${documentId}/serve/`;
        console.log('üìÑ URL del PDF:', pdfUrl);
        
        // Configurar controles
        $('#open-pdf-tab').attr('href', pdfUrl);
        $('#reload-pdf').off('click').on('click', function() {
            console.log('üîÑ Recargando PDF...');
            loadPDFInViewer(documentId, pdfUrl);
        });
        
        // Cargar PDF directamente
        loadPDFInViewer(documentId, pdfUrl);
        
        // Cargar datos del documento
        $.get(`/documents/${documentId}/data/`, function(data) {
            // Cargar datos del documento en el formulario
            $('#current-document-id').val(documentId);
            $('#document-title').text(data.title || 'Documento sin t√≠tulo');
            
            // Llenar formulario con datos existentes
            if (data.category_id) {
                $('#category').val(data.category_id).trigger('change');
                // Cargar tipos de documento despu√©s de seleccionar categor√≠a
                setTimeout(function() {
                    if (data.document_type_id) {
                        $('#document-type').val(data.document_type_id);
                    }
                }, 500);
            }
            
            if (data.person_id) {
                $('#person').val(data.person_id);
            }
            
            if (data.document_date) {
                $('#document-date').val(data.document_date);
            }
            
            $('#payment-status').val(data.payment_status);
            $('#status').val(data.status);
            $('#notes').val(data.notes);
            
            // Actualizar nombre estructurado
            $('#structured-name').text(data.structured_name);
            
            $('#view-history-btn').show().attr('href', `/documents/${documentId}/`);
        }).fail(function() {
            DocTrac.showNotification('Error al cargar el documento', 'error');
        });
    }
    
    // Manejar cambio de categor√≠a
    $('#category').on('change', function() {
        const categoryId = $(this).val();
        
        if (categoryId) {
            $.get('/documents/api/document-types/', {category_id: categoryId}, function(data) {
                const select = $('#document-type');
                select.empty().append('<option value="">Seleccionar tipo...</option>');
                
                data.document_types.forEach(function(type) {
                    select.append(`<option value="${type.id}">${type.name}</option>`);
                });
                
                select.prop('disabled', false);
            });
        } else {
            $('#document-type').empty()
                .append('<option value="">Primero selecciona categor√≠a...</option>')
                .prop('disabled', true);
        }
        
        updateStructuredName();
    });
    
    // Actualizar nombre estructurado cuando cambien los campos
    $('#document-type, #person, #document-date').on('change', updateStructuredName);
    
    function updateStructuredName() {
        const date = $('#document-date').val();
        const personText = $('#person option:selected').text();
        const typeText = $('#document-type option:selected').text();
        const categoryText = $('#category option:selected').text();
        
        let parts = [];
        
        if (date) {
            parts.push(date.replace(/-/g, ''));
        }
        if (personText && personText !== 'Seleccionar...') {
            parts.push(personText.replace(/\s+/g, '_').split('(')[0].trim());
        }
        if (typeText && typeText !== 'Seleccionar tipo...') {
            parts.push(typeText.replace(/\s+/g, '_'));
        }
        if (categoryText && categoryText !== 'Seleccionar categor√≠a...') {
            parts.push(categoryText.replace(/\s+/g, '_'));
        }
        
        const structuredName = parts.length > 0 ? parts.join('_') : 'Documento_sin_categorizar';
        $('#structured-name').text(structuredName);
    }
    
    // Manejar env√≠o del formulario
    $('#document-form').on('submit', function(e) {
        e.preventDefault();
        
        if (!currentDocumentId) {
            showAlert('No hay documento seleccionado', 'error');
            return;
        }
        
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        // Deshabilitar bot√≥n y mostrar estado de carga
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>Guardando...');
        
        const formData = {
            category_id: $('#category').val(),
            document_type_id: $('#document-type').val(),
            person_id: $('#person').val(),
            document_date: $('#document-date').val(),
            payment_status: $('#payment-status').val(),
            status: $('#status').val(),
            notes: $('#notes').val()
        };
        
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
            }
        });
        
        $.ajax({
            url: `/documents/${currentDocumentId}/update/`,
            type: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    DocTrac.showNotification(response.message, 'success');
                    
                    // Actualizar nombre estructurado con respuesta del servidor
                    if (response.structured_name) {
                        $('#structured-name').text(response.structured_name);
                    }
                    
                    // Remover documento de la lista si ya no est√° pendiente
                    if (formData.status !== 'pending') {
                        $(`.document-item[data-document-id="${currentDocumentId}"]`).fadeOut();
                    }
                } else {
                    DocTrac.showNotification(response.error, 'error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error al guardar:', error);
                let errorMessage = 'Error al guardar los cambios';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                DocTrac.showNotification(errorMessage, 'error');
            },
            complete: function() {
                // Restaurar bot√≥n independientemente del resultado
                submitBtn.prop('disabled', false);
                submitBtn.html(originalText);
            }
        });
    });
    
    // Funci√≥n simplificada para cargar PDF
    function loadPDFInViewer(documentId, pdfUrl) {
        console.log(`üìã Cargando PDF en viewer: ${pdfUrl}`);
        
        // HTML del iframe simplificado
        const iframeHtml = `
            <iframe id="pdf-iframe-${documentId}" 
                    src="${pdfUrl}" 
                    width="100%" 
                    height="100%" 
                    style="border: none; display: block;"
                    title="Vista previa PDF - Documento ${documentId}">
                <p style="padding: 20px; text-align: center;">
                    No se puede mostrar el PDF en este navegador.<br>
                    <a href="${pdfUrl}" target="_blank" style="color: #007bff;">
                        üìÑ Abrir PDF en nueva pesta√±a
                    </a>
                </p>
            </iframe>
        `;
        
        // Reemplazar contenido
        $('#pdf-viewer-container').html(iframeHtml);
        
        console.log(`‚úÖ Iframe creado para documento ${documentId}`);
    }
    
    // Funci√≥n para mostrar error de PDF
    function showPDFError(pdfUrl) {
        const errorHtml = `
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                    <h5>No se pudo cargar el PDF</h5>
                    <p class="text-muted mb-3">El archivo existe pero tu navegador no puede mostrarlo.</p>
                    <a href="${pdfUrl}" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt me-1"></i>Abrir en nueva pesta√±a
                    </a>
                </div>
            </div>
        `;
        $('#pdf-viewer-container').html(errorHtml);
    }

});
</script>
{% endblock %}